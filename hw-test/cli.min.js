"use strict";function Term(width,height,handler,tot_height){this.w=width;this.h=height;this.cur_h=height;if(!tot_height||tot_height<height)tot_height=height;this.tot_h=tot_height;this.y_base=0;this.y_disp=0;this.x=0;this.y=0;this.scroll_top=0;this.scroll_bottom=this.h;this.cursorstate=0;this.handler=handler;this.state=0;this.output_queue="";this.colors=["#000000","#aa0000","#00aa00","#aa5500","#0000aa","#aa00aa","#00aaaa","#aaaaaa","#555555","#ff5555","#55ff55","#ffff55","#5555ff","#ff55ff","#55ffff","#ffffff"];this.def_attr=7<<4|0;this.cur_attr=this.def_attr;this.is_mac=navigator.userAgent.indexOf("Mac")>=0?true:false;this.key_rep_state=0;this.key_rep_str="";this.utf8=true;this.utf8_state=0;this.utf8_val=0;this.application_cursor=false;this.application_keypad=false;this.linux_console=true}Term.prototype.open=function(parent_el){var y,line,i,term,c,row_el;this.lines=new Array;c=32|this.def_attr<<16;for(y=0;y<this.cur_h;y++){line=new Array;for(i=0;i<this.w;i++)line[i]=c;this.lines[y]=line}this.term_el=document.createElement("div");this.term_el.className="term";this.term_el.style.lineHeight="1.2em";this.term_el.style.width="calc("+this.w+"ch + 16px)";this.term_el.style.height=this.h*1.2+"em";this.scrollbar_el=document.createElement("div");this.scrollbar_el.className="term_scrollbar";this.term_el.appendChild(this.scrollbar_el);this.track_el=document.createElement("div");this.track_el.className="term_track";this.track_el.onmousedown=this.mouseMoveHandler.bind(this);this.scrollbar_el.appendChild(this.track_el);this.thumb_el=document.createElement("div");this.thumb_el.className="term_thumb";this.thumb_el.onmousedown=this.mouseDownHandler.bind(this);this.track_el.appendChild(this.thumb_el);this.end_el=document.createElement("div");this.end_el.className="term_end";this.thumb_el.appendChild(this.end_el);this.thumb_size=-1;this.thumb_pos=-1;this.content_el=document.createElement("div");this.content_el.className="term_content";this.content_el.style.width=this.w+"ch";this.term_el.appendChild(this.content_el);this.rows_el=[];for(y=0;y<this.h;y++){row_el=document.createElement("div");this.rows_el.push(row_el);this.content_el.appendChild(row_el)}this.parent_el=parent_el;parent_el.appendChild(this.term_el);this.refresh(0,this.h-1);this.term_el.addEventListener("wheel",this.wheelHandler.bind(this),false);term=this;setInterval(function(){term.cursor_timer_cb()},1e3)};Term.prototype.refresh_scrollbar=function(){var total_size,thumb_pos,thumb_size,y,y0;total_size=this.term_el.clientHeight;thumb_size=Math.ceil(this.h*total_size/this.cur_h);y0=(this.y_base+this.h)%this.cur_h;y=this.y_disp-y0;if(y<0)y+=this.cur_h;thumb_pos=Math.floor(y*total_size/this.cur_h);thumb_size=Math.max(thumb_size,30);thumb_size=Math.min(thumb_size,total_size);thumb_pos=Math.min(thumb_pos,total_size-thumb_size);if(thumb_pos!=this.thumb_pos||thumb_size!=this.thumb_size){this.thumb_pos=thumb_pos;this.thumb_size=thumb_size;this.thumb_el.style.top=thumb_pos+"px";this.thumb_el.style.height=thumb_size+"px"}};Term.prototype.refresh=function(ymin,ymax){var el,y,line,outline,c,w,i,j,cx,attr,last_attr,fg,bg,y1;var http_link_len,http_link_str,bold,tmp,inverse;function is_http_link_char(c){var str="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~:/?#[]@!$&'()*+,;=`.";return str.indexOf(String.fromCharCode(c))>=0}function right_trim(str,a){var i,n;n=a.length;i=str.length;while(i>=n&&str.substr(i-n,n)==a)i-=n;return str.substr(0,i)}for(y=ymin;y<=ymax;y++){y1=y+this.y_disp;if(y1>=this.cur_h)y1-=this.cur_h;line=this.lines[y1];outline="";w=this.w;if(y==this.y&&this.cursor_state&&this.y_disp==this.y_base){cx=this.x}else{cx=-1}last_attr=this.def_attr;http_link_len=0;for(i=0;i<w;i++){c=line[i];attr=c>>16;c&=65535;if(c==104&&w-i>=8&&http_link_len==0){if((line[i+1]&65535)==116&&(line[i+2]&65535)==116&&(line[i+3]&65535)==112&&((line[i+4]&65535)==58&&(line[i+5]&65535)==47&&(line[i+6]&65535)==47||(line[i+4]&65535)==115&&(line[i+5]&65535)==58&&(line[i+6]&65535)==47&&(line[i+7]&65535)==47)){http_link_str="";j=0;while(i+j<w&&is_http_link_char(line[i+j]&65535)){http_link_str+=String.fromCharCode(line[i+j]&65535);j++}http_link_len=j;if(last_attr!=this.def_attr){outline+="</span>";last_attr=this.def_attr}outline+="<a href='"+http_link_str+"'>"}}if(i==cx){attr=-1}if(attr!=last_attr){if(last_attr!=this.def_attr)outline+="</span>";if(attr!=this.def_attr){if(attr==-1){outline+='<span class="term_cursor">'}else{outline+='<span style="';fg=attr>>4&15;bg=attr&15;bold=attr>>8&1;inverse=attr>>9&1;if(inverse){tmp=fg;fg=bg;bg=tmp}if(bold){if(fg<8)fg+=8}if(fg!=7){outline+="color:"+this.colors[fg]+";"}if(bg!=0){outline+="background-color:"+this.colors[bg]+";"}outline+='">'}}}switch(c){case 32:outline+="&nbsp;";break;case 38:outline+="&amp;";break;case 60:outline+="&lt;";break;case 62:outline+="&gt;";break;default:if(c<32){outline+="&nbsp;"}else{outline+=String.fromCharCode(c)}break}last_attr=attr;if(http_link_len!=0){http_link_len--;if(http_link_len==0){if(last_attr!=this.def_attr){outline+="</span>";last_attr=this.def_attr}outline+="</a>"}}}if(last_attr!=this.def_attr){outline+="</span>"}outline=right_trim(outline,"&nbsp;");if(outline=="")outline="&nbsp;";this.rows_el[y].innerHTML=outline}this.refresh_scrollbar()};Term.prototype.cursor_timer_cb=function(){this.cursor_state^=1;this.refresh(this.y,this.y)};Term.prototype.show_cursor=function(){if(!this.cursor_state){this.cursor_state=1;this.refresh(this.y,this.y)}};Term.prototype.scroll_disp=function(n){var i,y1;if(n>=0){for(i=0;i<n;i++){if(this.y_disp==this.y_base)break;if(++this.y_disp==this.cur_h)this.y_disp=0}}else{n=-n;y1=this.y_base+this.h;if(y1>=this.cur_h)y1-=this.cur_h;for(i=0;i<n;i++){if(this.y_disp==y1)break;if(--this.y_disp<0)this.y_disp=this.cur_h-1}}this.refresh(0,this.h-1)};Term.prototype.write=function(str){var s,ymin,ymax;function update(y){ymin=Math.min(ymin,y);ymax=Math.max(ymax,y)}function get_erase_char(){var bg_mask,attr;bg_mask=15;attr=s.def_attr&~bg_mask|s.cur_attr&bg_mask;return 32|attr<<16}function erase_chars(x1,x2,y){var l,i,c,y1;y1=s.y_base+y;if(y1>=s.cur_h)y1-=s.cur_h;l=s.lines[y1];c=get_erase_char();for(i=x1;i<x2;i++)l[i]=c;update(y)}function erase_to_eol(x,y){erase_chars(x,s.w,y)}function erase_in_line(n){switch(n){case 0:erase_to_eol(s.x,s.y);break;case 1:erase_chars(0,s.x+1,s.y);break;case 2:erase_chars(0,s.w,s.y);break}}function erase_in_display(n){var y;switch(n){case 0:erase_to_eol(s.x,s.y);for(y=s.y+1;y<s.h;y++)erase_to_eol(0,y);break;case 1:erase_chars(0,s.x+1,s.y);for(y=0;y<s.y;y++){erase_to_eol(0,y)}break;case 2:for(y=0;y<s.h;y++){erase_to_eol(0,y)}break}}function delete_chars(n){var l,i,c,y1,j;y1=s.y+s.y_base;if(y1>=s.cur_h)y1-=s.cur_h;l=s.lines[y1];if(n<1)n=1;c=get_erase_char();j=s.x+n;for(i=s.x;i<s.w;i++){if(j<s.w)l[i]=l[j];else l[i]=c;j++}update(s.y)}function insert_chars(n){var l,i,c,y1,x1;if(n<1)n=1;if(n>s.w-s.x)n=s.w-s.x;y1=s.y+s.y_base;if(y1>=s.cur_h)y1-=s.cur_h;l=s.lines[y1];x1=s.x+n;for(i=s.w-1;i>=x1;i--)l[i]=l[i-n];c=get_erase_char();for(i=s.x;i<x1;i++)l[i]=c;update(s.y)}function csi_colors(esc_params){var j,n,fg,bg,mask;if(esc_params.length==0){s.cur_attr=s.def_attr}else{for(j=0;j<esc_params.length;j++){n=esc_params[j];if(n>=30&&n<=37){fg=n-30;s.cur_attr=s.cur_attr&~(15<<4)|fg<<4}else if(n>=40&&n<=47){bg=n-40;s.cur_attr=s.cur_attr&~15|bg}else if(n>=90&&n<=97){fg=n-90+8;s.cur_attr=s.cur_attr&~(15<<4)|fg<<4}else if(n>=100&&n<=107){bg=n-100+8;s.cur_attr=s.cur_attr&~15|bg}else if(n==1){s.cur_attr|=1<<8}else if(n==0){s.cur_attr=s.def_attr}else if(n==7){s.cur_attr|=1<<9}else if(n==27){s.cur_attr&=~(1<<9)}else if(n==39){mask=15<<4;s.cur_attr=s.cur_attr&~mask|s.def_attr&mask}else if(n==49){mask=15;s.cur_attr=s.cur_attr&~mask|s.def_attr&mask}}}}function empty_line(y,use_erase_char){var line,c,y1,x;if(use_erase_char)c=get_erase_char();else c=32|s.def_attr<<16;line=new Array;for(x=0;x<s.w;x++)line[x]=c;y1=s.y_base+y;if(y1>=s.cur_h)y1-=s.cur_h;s.lines[y1]=line}function scroll_down(top,bottom,use_erase_char){var y,line,y1,y2;if(top==0&&bottom==s.h){if(s.cur_h<s.tot_h){s.cur_h++}if(++s.y_base==s.cur_h)s.y_base=0;s.y_disp=s.y_base}else{for(y=top;y<bottom-1;y++){y1=s.y_base+y;if(y1>=s.cur_h)y1-=s.cur_h;y2=y1+1;if(y2>=s.cur_h)y2-=s.cur_h;s.lines[y1]=s.lines[y2]}}empty_line(bottom-1,use_erase_char);update(top);update(bottom-1)}function scroll_up(top,bottom,use_erase_char){var y,y1,y2;for(y=bottom-1;y>top;y--){y1=s.y_base+y;if(y1>=s.cur_h)y1-=s.cur_h;y2=y1-1;if(y2>=s.cur_h)y2-=s.cur_h;s.lines[y1]=s.lines[y2]}empty_line(top,use_erase_char);update(top);update(bottom-1)}function down_with_scroll(){s.y++;if(s.y==s.scroll_bottom){s.y--;scroll_down(s.scroll_top,s.scroll_bottom,false)}else if(s.y>=s.h){s.y--;scroll_down(0,s.h,false)}}function up_with_scroll(){if(s.y==s.scroll_top){scroll_up(s.scroll_top,s.scroll_bottom,true)}else if(s.y==0){scroll_up(0,s.h,true)}else{s.y--}}function insert_lines(n){var y2;if(n<1)n=1;if(s.y<s.scroll_bottom)y2=s.scroll_bottom;else y2=s.h;while(n!=0){scroll_up(s.y,y2,true);n--}}function delete_lines(n){var y2;if(n<1)n=1;if(s.y<s.scroll_bottom)y2=s.scroll_bottom;else y2=s.h;while(n!=0){scroll_down(s.y,y2,true);n--}}var TTY_STATE_NORM=0;var TTY_STATE_ESC=1;var TTY_STATE_CSI=2;var TTY_STATE_CHARSET=3;function handle_char(c){var i,l,n,j,y1,y2,x1;switch(s.state){case TTY_STATE_NORM:switch(c){case 10:down_with_scroll();break;case 13:s.x=0;break;case 8:if(s.x>0){s.x--}break;case 9:n=s.x+8&~7;if(n<=s.w){s.x=n}break;case 27:s.state=TTY_STATE_ESC;break;default:if(c>=32){if(s.x>=s.w){s.x=0;down_with_scroll()}y1=s.y+s.y_base;if(y1>=s.cur_h)y1-=s.cur_h;s.lines[y1][s.x]=c&65535|s.cur_attr<<16;s.x++;update(s.y)}break}break;case TTY_STATE_ESC:switch(c){case 91:s.esc_params=new Array;s.cur_param=0;s.esc_prefix=0;s.state=TTY_STATE_CSI;break;case 40:case 41:s.state=TTY_STATE_CHARSET;break;case 61:s.application_keypad=true;s.state=TTY_STATE_NORM;break;case 62:s.application_keypad=false;s.state=TTY_STATE_NORM;break;case 77:up_with_scroll();s.state=TTY_STATE_NORM;break;default:s.state=TTY_STATE_NORM;break}break;case TTY_STATE_CSI:if(c>=48&&c<=57){s.cur_param=s.cur_param*10+c-48}else{if(c==63){s.esc_prefix=c;break}s.esc_params[s.esc_params.length]=s.cur_param;s.cur_param=0;if(c==59)break;s.state=TTY_STATE_NORM;switch(c){case 64:insert_chars(s.esc_params[0]);break;case 65:n=s.esc_params[0];if(n<1)n=1;s.y-=n;if(s.y<0)s.y=0;break;case 66:n=s.esc_params[0];if(n<1)n=1;s.y+=n;if(s.y>=s.h)s.y=s.h-1;break;case 67:n=s.esc_params[0];if(n<1)n=1;s.x+=n;if(s.x>=s.w-1)s.x=s.w-1;break;case 68:n=s.esc_params[0];if(n<1)n=1;s.x-=n;if(s.x<0)s.x=0;break;case 71:x1=s.esc_params[0]-1;if(x1<0)x1=0;else if(x1>=s.w)x1=s.w-1;s.x=x1;break;case 72:y1=s.esc_params[0]-1;if(s.esc_params.length>=2)x1=s.esc_params[1]-1;else x1=0;if(y1<0)y1=0;else if(y1>=s.h)y1=s.h-1;if(x1<0)x1=0;else if(x1>=s.w)x1=s.w-1;s.x=x1;s.y=y1;break;case 74:erase_in_display(s.esc_params[0]);break;case 75:erase_in_line(s.esc_params[0]);break;case 76:insert_lines(s.esc_params[0]);break;case 77:delete_lines(s.esc_params[0]);break;case 80:delete_chars(s.esc_params[0]);break;case 100:{y1=s.esc_params[0]-1;if(y1<0)y1=0;else if(y1>=s.h)y1=s.h-1;s.y=y1}break;case 104:if(s.esc_prefix==63&&s.esc_params[0]==1){s.application_cursor=true}break;case 108:if(s.esc_prefix==63&&s.esc_params[0]==1){s.application_cursor=false}break;case 109:csi_colors(s.esc_params);break;case 110:s.queue_chars("["+(s.y+1)+";"+(s.x+1)+"R");break;case 114:y1=s.esc_params[0]-1;if(y1<0)y1=0;else if(y1>=s.h)y1=s.h-1;if(s.esc_params.length>=2)y2=s.esc_params[1];else y2=s.h;if(y2>=s.h||y2<=y1)y2=s.h;s.scroll_top=y1;s.scroll_bottom=y2;s.x=0;s.y=0;break;default:break}}break;case TTY_STATE_CHARSET:s.state=TTY_STATE_NORM;break}}function handle_utf8(c){if(s.utf8_state!==0&&(c>=128&&c<192)){s.utf8_val=s.utf8_val<<6|c&63;s.utf8_state--;if(s.utf8_state===0){handle_char(s.utf8_val)}}else if(c>=192&&c<248){s.utf8_state=1+(c>=224)+(c>=240);s.utf8_val=c&(1<<6-s.utf8_state)-1}else{s.utf8_state=0;handle_char(c)}}var i,c,utf8;s=this;ymin=s.h;ymax=-1;update(s.y);if(s.y_base!=s.y_disp){s.y_disp=s.y_base;ymin=0;ymax=s.h-1}utf8=s.utf8;for(i=0;i<str.length;i++){c=str.charCodeAt(i);if(utf8)handle_utf8(c);else handle_char(c)}update(s.y);if(ymax>=ymin)s.refresh(ymin,ymax)};Term.prototype.writeln=function(str){this.write(str+"\r\n")};Term.prototype.interceptBrowserExit=function(ev){if(ev.ctrlKey){window.onbeforeunload=function(){window.onbeforeunload=null;return"CTRL-W or Ctrl-Q cannot be sent to the emulator."}}else{window.onbeforeunload=null}};Term.prototype.keyDownHandler=function(ev){var str;this.interceptBrowserExit(ev);str="";switch(ev.keyCode){case 8:str="";break;case 9:str="\t";break;case 13:str="\r";break;case 27:str="";break;case 37:if(ev.ctrlKey){str="[1;5D"}else if(this.application_cursor){str="OD"}else{str="[D"}break;case 39:if(ev.ctrlKey){str="[1;5C"}else if(this.application_cursor){str="OC"}else{str="[C"}break;case 38:if(ev.ctrlKey){this.scroll_disp(-1)}else if(this.application_cursor){str="OA"}else{str="[A"}break;case 40:if(ev.ctrlKey){this.scroll_disp(1)}else if(this.application_cursor){str="OB"}else{str="[B"}break;case 46:str="[3~";break;case 45:str="[2~";break;case 36:if(this.linux_console)str="[1~";else if(this.application_keypad)str="OH";else str="[H";break;case 35:if(this.linux_console)str="[4~";else if(this.application_keypad)str="OF";else str="[F";break;case 33:if(ev.ctrlKey){this.scroll_disp(-(this.h-1))}else{str="[5~"}break;case 34:if(ev.ctrlKey){this.scroll_disp(this.h-1)}else{str="[6~"}break;default:if(ev.ctrlKey){if(ev.keyCode>=65&&ev.keyCode<=90){str=String.fromCharCode(ev.keyCode-64)}else if(ev.keyCode==32){str=String.fromCharCode(0)}}else if(!this.is_mac&&ev.altKey||this.is_mac&&ev.metaKey){if(ev.keyCode>=65&&ev.keyCode<=90){str=""+String.fromCharCode(ev.keyCode+32)}}break}if(str){if(ev.stopPropagation)ev.stopPropagation();if(ev.preventDefault)ev.preventDefault();this.show_cursor();this.key_rep_state=1;this.key_rep_str=str;this.handler(str);return false}else{this.key_rep_state=0;return true}};Term.prototype.keyUpHandler=function(ev){this.interceptBrowserExit(ev)};Term.prototype.to_utf8=function(s){var i,n=s.length,r,c;r="";for(i=0;i<n;i++){c=s.charCodeAt(i);if(c<128){r+=String.fromCharCode(c)}else if(c<2048){r+=String.fromCharCode(c>>6|192,c&63|128)}else if(c<65536){r+=String.fromCharCode(c>>12|224,c>>6&63|128,c&63|128)}else{r+=String.fromCharCode(c>>18|240,c>>12&63|128,c>>6&63|128,c&63|128)}}return r};Term.prototype.keyPressHandler=function(ev){var str,char_code;if(ev.stopPropagation)ev.stopPropagation();if(ev.preventDefault)ev.preventDefault();str="";if(!("charCode"in ev)){char_code=ev.keyCode;if(this.key_rep_state==1){this.key_rep_state=2;return false}else if(this.key_rep_state==2){this.show_cursor();this.handler(this.key_rep_str);return false}}else{char_code=ev.charCode}if(char_code!=0){if(!ev.ctrlKey&&(!this.is_mac&&!ev.altKey||this.is_mac&&!ev.metaKey)){str=String.fromCharCode(char_code)}}if(str){this.show_cursor();if(this.utf8)str=this.to_utf8(str);this.handler(str);return false}else{return true}};Term.prototype.blurHandler=function(ev){window.onbeforeunload=null};Term.prototype.wheelHandler=function(ev){if(ev.deltaY<0)this.scroll_disp(-1);else if(ev.deltaY>0)this.scroll_disp(1);ev.stopPropagation()};Term.prototype.mouseDownHandler=function(ev){this.thumb_el.onmouseup=this.mouseUpHandler.bind(this);document.onmousemove=this.mouseMoveHandler.bind(this);document.onmouseup=this.mouseUpHandler.bind(this);document.body.className+=" noSelect";this.mouseMoveHandler(ev)};Term.prototype.mouseMoveHandler=function(ev){var total_size,pos,new_y_disp,y,y0;total_size=this.term_el.clientHeight;y=ev.clientY-this.track_el.getBoundingClientRect().top;pos=Math.floor((y-this.thumb_size/2)*this.cur_h/total_size);new_y_disp=Math.min(Math.max(pos,0),this.cur_h-this.h);y0=(this.y_base+this.h)%this.cur_h;new_y_disp+=y0;if(new_y_disp>=this.cur_h)new_y_disp-=this.cur_h;if(new_y_disp!=this.y_disp){this.y_disp=new_y_disp;this.refresh(0,this.h-1)}};Term.prototype.mouseUpHandler=function(ev){this.thumb_el.onmouseup=null;document.onmouseup=null;document.onmousemove=null;document.body.className=document.body.className.replace(" noSelect","")};Term.prototype.queue_chars=function(str){this.output_queue+=str;if(this.output_queue)setTimeout(this.outputHandler.bind(this),0)};Term.prototype.outputHandler=function(){if(this.output_queue){this.handler(this.output_queue);this.output_queue=""}};Term.prototype.getSize=function(){return[this.w,this.h]};"use strict";var term,console_write1;var graphic_display,display_key_event,display_mouse_event;var net_state,net_write_packet,net_set_carrier;var display_wheel_event;var fs_import_file;var Module={};var downloading_timer_pending=false;var downloading_timer;function on_update_file(f){var f,reader;reader=new FileReader;reader.onload=function(ev){var buf,buf_addr,buf_len;buf=new Uint8Array(reader.result);buf_len=buf.length;buf_addr=_malloc(buf_len);HEAPU8.set(buf,buf_addr);fs_import_file(f.name,buf_addr,buf_len)};reader.readAsArrayBuffer(f)}function on_update_files(files){var i,n;n=files.length;for(i=0;i<n;i++){on_update_file(files[i])}}function term_handler(str){var i;for(i=0;i<str.length;i++){console_write1(str.charCodeAt(i))}}function downloading_timer_cb(){var el=document.getElementById("net_progress");el.style.visibility="hidden";downloading_timer_pending=false}function update_downloading(flag){var el;if(flag){if(downloading_timer_pending){clearTimeout(downloading_timer);downloading_timer_pending=false}else{el=document.getElementById("net_progress");el.style.visibility="visible"}}else{downloading_timer_pending=true;downloading_timer=setTimeout(downloading_timer_cb,500)}}function get_params(){return{cpu:"x86",rows:20,font_size:16}}function get_absolute_url(fname){var path,p;if(fname.indexOf(":")>=0)return fname;path=window.location.pathname;p=path.lastIndexOf("/");if(p<0)return fname;return window.location.origin+path.slice(0,p+1)+fname}function start_vm(user,pwd){var url,mem_size,cpu,params,vm_url,cmdline,cols,rows,guest_url;var font_size,graphic_enable,width,height,net_url,alloc_size;var drive_url,vm_file;function loadScript(src,f){var head=document.getElementsByTagName("head")[0];var script=document.createElement("script");script.src=src;var done=false;script.onload=script.onreadystatechange=function(){if(!done&&(!this.readyState||this.readyState=="loaded"||this.readyState=="complete")){done=true;if(f){f()}script.onload=script.onreadystatechange=null;head.removeChild(script)}};head.appendChild(script)}function start(){console_write1=Module.cwrap("console_queue_char",null,["number"]);fs_import_file=Module.cwrap("fs_import_file",null,["string","number","number"]);display_key_event=Module.cwrap("display_key_event",null,["number","number"]);display_mouse_event=Module.cwrap("display_mouse_event",null,["number","number","number"]);display_wheel_event=Module.cwrap("display_wheel_event",null,["number"]);net_write_packet=Module.cwrap("net_write_packet",null,["number","number"]);net_set_carrier=Module.cwrap("net_set_carrier",null,["number"]);net_state=null;Module.ccall("vm_start",null,["string","number","string","string","number","number","number","string"],[url,mem_size,cmdline,pwd,width,height,net_state!=null|0,drive_url]);pwd=null}params=get_params();cpu=params["cpu"]||"riscv64";url=params["url"];if(!url){if(cpu=="x86")url="root-x86.cfg";else url="root-riscv64.cfg"}url=get_absolute_url(url);mem_size=params["mem"]|0||128;cmdline=params["cmdline"]||"";cols=params["cols"]|0||80;rows=params["rows"]|0||30;font_size=params["font_size"]|0||15;guest_url=params["guest_url"]||"";width=params["w"]|0||1024;height=params["h"]|0||640;graphic_enable=params["graphic"]|0;net_url=params["net_url"]||"";if(typeof net_url=="undefined")net_url="wss://relay.widgetry.org/";drive_url=params["drive_url"]||"";if(user){cmdline+=" LOGIN_USER="+user}else if(guest_url){cmdline+=" GUEST_URL="+guest_url}width=0;height=0;term=new Term(cols,rows,term_handler,1e4);term.open(document.getElementById("term_container"));term.term_el.style.fontSize=font_size+"px";term.write("Loading...\r\n");switch(cpu){case"x86":vm_file="x86emu";break;case"riscv64":case"riscv":vm_file="riscvemu64";break;case"riscv32":vm_file="riscvemu32";break;default:term.writeln("Unknown cpu="+cpu);return}if(typeof WebAssembly==="object"){vm_url=vm_file+"-wasm.js"}else{alloc_size=mem_size;if(cpu=="x86")alloc_size+=16;if(graphic_enable){alloc_size+=width*height*4+1048576-1>>20}alloc_size+=32;alloc_size=alloc_size+15&-16;Module.TOTAL_MEMORY=alloc_size<<20;vm_url=vm_file+".js"}Module.preRun=start;loadScript(vm_url,null)}function on_login(){var login_wrap_el=document.getElementById("wrap");var term_wrap_el=document.getElementById("term_wrap");var form=document.getElementById("form");var status=document.getElementById("status");var user=form.user.value;var pwd=form.password.value;if(user.length<=1){status.innerHTML="User name must be provided";return false}login_wrap_el.style.display="none";term_wrap_el.style.display="block";form.password.value="";form.user.value="";start_vm(user,pwd);return false}(function(){var login,params;params=get_params();login=params["login"]||0;if(login){var login_wrap_el=document.getElementById("wrap");login_wrap_el.style.display="block"}else{var term_wrap_el=document.getElementById("term_wrap");term_wrap_el.style.display="block";start_vm(null,null)}})();const exercises=[{description:"Print the current working directory.",expected:{command:"pwd",workdir:"/root",args:null,output:/\/root/}},{description:"Create a new directory called <code>exercise</code>.",expected:{command:"mkdir",workdir:"/root",args:/.*exercise\/?/,output:null}},{description:"Change the current working directory to <code>exercise</code>.",expected:{command:"cd",workdir:"/root/exercise",args:null,output:null}},{description:"Create an empty file called <code>notes.txt</code>.",expected:{command:"touch",workdir:"/root/exercise",args:/.*notes\.txt/,output:null}},{description:"List all files in the current working directory.",expected:{command:"ls",workdir:"/root/exercise",args:null,output:/.*notes\.txt.*/}},{description:"Rename <code>notes.txt</code> to <code>notes1.txt</code>.",expected:{command:"mv",workdir:"/root/exercise",args:/notes\.txt +notes1\.txt/,output:null}},{description:"Duplicate (make a copy of) <code>notes1.txt</code> as <code>notes2.txt</code>.",expected:{command:"cp",workdir:"/root/exercise",args:/notes1\.txt +notes2\.txt/,output:null}},{description:"Delete <code>notes1.txt</code>.",expected:{command:"rm",workdir:"/root/exercise",args:/.*notes1\.txt/,output:null}},{description:"Change the current working directory back to <code>/root</code>.",expected:{command:"cd",workdir:"/root",args:null,output:null}},{description:"List all files in the current working directory in the <i>long listing format</i>.",expected:{command:"ls",workdir:"/root",args:/.*-l.*/,output:/.*exercise.*/}},{description:"Delete the <code>exercise</code> directory and its files with <i>a single command</i>.",expected:{command:"rm",workdir:"/root",args:/.*-(r|R).*exercise\/?/,output:null}}];"use strict";let currentId=-1;const commandDescriptions={cd:"changing the current working directory",cp:"copying files",ls:"listing the contents of a directory",mkdir:"creating directories",mv:"moving or renaming a file",pwd:"printing the current working directory",rm:"deleting files",rmdir:"deleting directories",touch:"creating an empty file"};const keyDownHandler=term.keyDownHandler.bind(term);const keyUpHandler=term.keyUpHandler.bind(term);const blurHandler=term.blurHandler.bind(term);const keyPressHandler=term.keyPressHandler.bind(term);function loadNextExercise(){const currentExercise=document.querySelector(".current");currentExercise?.classList.remove("current");currentId+=1;if(currentId<exercises.length){document.querySelector("#exercises").innerHTML+=`
      <li class="exercise current">${exercises[currentId].description}</li>
    `}}function parseLastActionFromTerminal(){let command="";let workdir="";let outputLines=[];document.querySelectorAll(".term_content > div").forEach(elem=>{const text=elem.textContent.replaceAll(/\u00a0/g," ");const cmdPromptMatch=text.match(/^(\/.*)#(.*)$/);if(cmdPromptMatch){workdir=cmdPromptMatch[1].trim();if(cmdPromptMatch[2].match(/\S/)){outputLines=[];command=cmdPromptMatch[2].replace(/\\$/,"")}}else if(text.startsWith(">")){command+=text.slice(2)}else if(text.match(/\S/)){outputLines.push(text)}});command=command.replaceAll(/ +/g," ").trim();return{command:command,workdir:workdir,outputLines:outputLines}}function runTest({command,workdir,outputLines}){const exercise=exercises[currentId];const expectedCommandRegExp=new RegExp(`^${exercise.expected.command} ?${exercise.expected.args?.source??".*"}$`);const expectedOutputRegExp=exercise.expected.output?new RegExp(`^${exercise.expected.output.source}$`):null;const baseCommand=command?.split(" ")[0];const feedbackElem=document.querySelector("#feedback");if(!command){return false}if(expectedCommandRegExp.test(command)&&exercise.expected.workdir===workdir&&(!expectedOutputRegExp||outputLines.some(line=>expectedOutputRegExp.test(line)))){const remaining=exercises.length-currentId-1;if(remaining>0){feedbackElem.innerHTML=`Well done! &#128077; ${remaining} more to go.`}else{feedbackElem.innerHTML="Perfection! &#128170; All done.";saveCompletedExercise(EXERCISE_ID)}return true}if(baseCommand===exercise.expected.command&&workdir!==exercise.expected.workdir){feedbackElem.innerHTML=`
      <code>${baseCommand}</code> is the right command to use, but you are
      in the wrong working directory.
    `;return false}if(baseCommand===exercise.expected.command){feedbackElem.innerHTML=`
      <code>${baseCommand}</code> is the right command to use, but with
      different options or arguments. Run
      <code>${baseCommand}&nbsp;--help</code> to see how it works.
    `;return false}if(baseCommand in commandDescriptions){feedbackElem.innerHTML=`
      The <code>${baseCommand}</code> command is for
      ${commandDescriptions[baseCommand]}, you need a different one.
    `;return false}if(/: not found/.test(outputLines[outputLines.length-1])){feedbackElem.innerHTML="Looks like you might have a typo somewhere.";return false}feedbackElem.innerHTML=`
    It is probably not the <code>${baseCommand}</code> command that you need
    right now.
  `;return false}function handleNewCommand(event){if(event.code==="Enter"||event.code==="NumpadEnter"){setTimeout(()=>{const pass=runTest(parseLastActionFromTerminal());if(pass){setTimeout(loadNextExercise,1e3)}},250)}}function enableKeyCapture(){term.term_el.classList.add("term-focus");document.addEventListener("keydown",keyDownHandler,true);document.addEventListener("keyup",keyUpHandler,true);document.addEventListener("blur",blurHandler,true);document.addEventListener("keypress",keyPressHandler,true);document.addEventListener("keyup",handleNewCommand)}function disableKeyCapture(){term.term_el.classList.remove("term-focus");document.removeEventListener("keydown",keyDownHandler,true);document.removeEventListener("keyup",keyUpHandler,true);document.removeEventListener("blur",blurHandler,true);document.removeEventListener("keypress",keyPressHandler,true);document.removeEventListener("keyup",handleNewCommand)}document.addEventListener("DOMContentLoaded",async()=>{loadNextExercise();document.addEventListener("click",event=>{if(term.term_el.contains(event.target)){enableKeyCapture()}else{disableKeyCapture()}})});